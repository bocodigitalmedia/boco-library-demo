<!doctype html>
<html>
<head>
  <title>Library Demo</title>
</head>
<body>

  <ul id="allDocumentsView">
  </ul>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    var socket = io();
    var viewEl = document.getElementById("allDocumentsView");

    function createDocumentViewElement(doc) {
      var linkEl = document.createElement("a");
      linkEl.setAttribute("href", doc.url);
      linkEl.innerText = doc.name;

      var divEl = document.createElement("div");
      divEl.appendChild(linkEl);

      var listEl = document.createElement("li");
      listEl.setAttribute("id", "document-" + doc.id);
      listEl.appendChild(divEl);

      return listEl;
    }

    function onDocumentListReceived() {
      var json = this.responseText;
      var docs = JSON.parse(json);
      var id, doc, docViewEl;
      var chunks = [];

      viewEl.innerHTML = "";

      for(id in docs) {
        if(docs.hasOwnProperty(id)) {
          doc = docs[id];
          docViewEl = createDocumentViewElement(doc);
          viewEl.appendChild(docViewEl);
        }
      }

    }

    function updateDocumentView() {
      var xhr = new XMLHttpRequest();
      xhr.onload = onDocumentListReceived;
      xhr.open("get", "/documents", true);
      xhr.send();
    }

    function removeDocument(doc) {
      console.log("removed", doc);
      var docElId = "document-" + doc.id;
      var docEl = document.getElementById(docElId);
      viewEl.removeChild(docEl);
    }

    function addDocument(doc) {
      console.log("added", doc);
      var docEl = createDocumentViewElement(doc);
      viewEl.appendChild(docEl);
    }

    function changeDocument(doc) {
      console.log("change", doc);
      var docElId = "document-" + doc.id;
      var oldEl = document.getElementById(docElId);
      var newEl = createDocumentViewElement(doc);
      viewEl.replaceChild(newEl, oldEl);
    }

    socket.on("library.document.deleted", removeDocument);
    socket.on("library.document.inserted", addDocument);
    socket.on("library.document.updated", changeDocument);

    window.onload = updateDocumentView;
  </script>
</body>
